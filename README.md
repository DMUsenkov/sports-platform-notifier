# Telegram-бот для уведомлений о спортивных соревнованиях

Telegram-бот для отправки уведомлений пользователям онлайн-платформы для поиска и управления любительскими спортивными соревнованиями.

## Оглавление

- [Описание](#описание)
- [Функциональные возможности](#функциональные-возможности)
- [Типы уведомлений](#типы-уведомлений)
- [Технологический стек](#технологический-стек)
- [Требования к системе](#требования-к-системе)
- [Установка и запуск](#установка-и-запуск)
  - [Через Docker](#через-docker)
  - [Локальная установка](#локальная-установка)
- [Конфигурация](#конфигурация)
- [Команды бота](#команды-бота)
- [Архитектура проекта](#архитектура-проекта)
- [Структура базы данных](#структура-базы-данных)
- [API Интеграция](#api-интеграция)
- [Разработка и вклад](#разработка-и-вклад)
- [Решение проблем](#решение-проблем)
- [Лицензия](#лицензия)

## Описание

Данный Telegram-бот разработан для отправки уведомлений пользователям онлайн-платформы для поиска и управления любительскими спортивными соревнованиями. Бот интегрируется с основным веб-приложением и позволяет пользователям получать актуальные уведомления о событиях, связанных с чемпионатами, матчами, командами и оргкомитетами.

## Функциональные возможности

- Отправка различных типов уведомлений через Telegram
- Привязка аккаунта пользователя по номеру телефона
- Просмотр информации о предстоящих матчах
- Просмотр информации о командах и чемпионатах
- Ответы на приглашения в команды и оргкомитеты
- Отклонение участия в матчах
- Просмотр рекомендуемых чемпионатов

## Типы уведомлений

Бот отправляет следующие типы уведомлений:

1. **Заявки на чемпионаты**: уведомления об отправке заявок на участие в чемпионатах
2. **Отмена/отклонение заявок**: информация о статусе заявок
3. **Статус чемпионатов**: уведомления об отмене или завершении чемпионатов
4. **Новые матчи**: информация о назначении нового матча для команды пользователя
5. **Перенос матчей**: уведомления об изменении времени или места проведения матча
6. **Результаты плей-офф**: информация о проходе или непроходе команды в плей-офф
7. **Напоминания о матчах**: напоминания за 24 часа до начала матча
8. **Рекомендуемые чемпионаты**: информация о новых чемпионатах, которые могут заинтересовать пользователя
9. **Сообщения от оргкомитетов**: важные объявления от организаторов чемпионатов
10. **Приглашения в команды**: уведомления о приглашении пользователя в спортивную команду
11. **Приглашения в оргкомитеты**: уведомления о приглашении пользователя в оргкомитет чемпионата

## Технологический стек

- **Python 3.11+**: основной язык программирования
- **Aiogram 2.25.1**: фреймворк для создания Telegram-ботов
- **SQLAlchemy 2.0.27**: ORM для работы с базой данных
- **PostgreSQL**: СУБД для хранения данных
- **Docker и Docker Compose**: контейнеризация и оркестрация
- **Aiohttp**: асинхронные HTTP-запросы к API основного приложения

## Требования к системе

### Серверные требования
- Python 3.11 или выше
- PostgreSQL 12 или выше
- Docker и Docker Compose (для развертывания через контейнеры)
- Доступ к API основного приложения

### Клиентские требования
- Telegram-клиент (мобильное приложение, веб-версия или десктопное приложение)
- Мобильное приложение Telegram не ниже версии 10.0
- Приложение Telegram для macOS не ниже версии 10.0
- Telegram Desktop не ниже версии 4.0
- Браузер с поддержкой Telegram Web

## Установка и запуск

### Через Docker

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/sports-platform-notifier.git
   cd sports-platform-notifier
   ```

2. Создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```

3. Отредактируйте `.env` файл, добавив необходимые параметры:
   ```
   TELEGRAM_BOT_TOKEN=your_telegram_bot_token
   DB_HOST=db
   DB_PORT=5432
   DB_NAME=sports_platform
   DB_USER=postgres
   DB_PASSWORD=secure_password
   API_BASE_URL=http://your-main-app/api
   API_TOKEN=your_api_token
   ```

4. Запустите контейнеры с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

5. Проверьте логи для подтверждения успешного запуска:
   ```bash
   docker-compose logs -f bot
   ```

### Локальная установка

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/sports-platform-notifier.git
   cd sports-platform-notifier
   ```

2. Создайте и активируйте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # для Linux/macOS
   venv\Scripts\activate  # для Windows
   ```

3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

4. Создайте файл `.env` на основе `.env.example` и настройте его.

5. Запустите бота:
   ```bash
   python -m bot.main
   ```

## Конфигурация

Для настройки бота используется файл `.env` со следующими параметрами:

| Параметр | Описание | Пример |
|----------|----------|--------|
| `TELEGRAM_BOT_TOKEN` | Токен Telegram-бота (получить у @BotFather) | `1234567890:AAH-abcdefghijklmnopqrs` |
| `DB_HOST` | Хост базы данных PostgreSQL | `localhost` или `db` в Docker |
| `DB_PORT` | Порт базы данных | `5432` |
| `DB_NAME` | Название базы данных | `sports_platform` |
| `DB_USER` | Пользователь базы данных | `postgres` |
| `DB_PASSWORD` | Пароль базы данных | `secure_password` |
| `API_BASE_URL` | Базовый URL для API основного приложения | `http://localhost:8080/api` |
| `API_TOKEN` | Токен для авторизации в API | `your_api_token` |
| `API_TIMEOUT` | Таймаут для запросов к API (в секундах) | `2` |
| `LOG_LEVEL` | Уровень логирования | `INFO`, `DEBUG`, `ERROR` |
| `MAX_RPS` | Максимальное количество запросов в секунду | `1000` |

## Команды бота

Бот поддерживает следующие команды:

| Команда | Описание |
|---------|----------|
| `/start` | Начать работу с ботом и привязать аккаунт по номеру телефона |
| `/help` | Получить справку по использованию бота |
| `/changephone` | Изменить привязанный номер телефона |
| `/invitations` | Просмотреть активные приглашения |
| `/team_<ID>` | Просмотреть информацию о команде (например, `/team_123`) |
| `/championship_<ID>` | Просмотреть информацию о чемпионате (например, `/championship_456`) |

Кроме команд, бот предоставляет интерфейс с кнопками для доступа к различным функциям:

- **Мои матчи**: просмотр предстоящих матчей
- **Мои чемпионаты**: просмотр чемпионатов пользователя
- **Мои команды**: просмотр команд пользователя
- **Рекомендуемые чемпионаты**: просмотр чемпионатов, которые могут заинтересовать пользователя
- **Приглашения**: просмотр активных приглашений
- **Помощь**: получение справки по использованию бота

## Архитектура проекта

```
sports_platform_notifier/
├── bot/
│   ├── __init__.py
│   ├── main.py              # Основной файл бота
│   ├── handlers/            # Обработчики сообщений
│   │   ├── __init__.py
│   │   ├── user.py          # Обработчики для обычных пользователей
│   │   ├── notification.py  # Обработчики для уведомлений
│   │   ├── match.py         # Обработчики для матчей
│   │   └── championship.py  # Обработчики для чемпионатов
│   ├── keyboards/           # Клавиатуры
│   │   ├── __init__.py
│   │   └── keyboards.py
│   └── messages/            # Шаблоны сообщений
│       ├── __init__.py
│       └── templates.py
├── database/
│   ├── __init__.py
│   ├── connection.py        # Подключение к базе данных
│   ├── models.py            # Модели данных
│   └── repositories/        # Репозитории для работы с данными
│       ├── __init__.py  
│       ├── user_repository.py
│       └── notification_repository.py
├── config/
│   ├── __init__.py
│   └── config.py            # Конфигурация приложения
├── api/
│   ├── __init__.py
│   └── client.py            # Клиент для взаимодействия с основным приложением
├── utils/
│   ├── __init__.py
│   └── logger.py            # Логирование
├── logs/                    # Директория для логов
├── requirements.txt         # Зависимости проекта
├── Dockerfile               # Конфигурация Docker
├── docker-compose.yml       # Конфигурация Docker Compose
└── .env                     # Файл с переменными окружения
```

## Структура базы данных

Бот использует две основные таблицы в базе данных:

### Таблица `users`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer | Первичный ключ |
| `phone_number` | String | Номер телефона пользователя (уникальный) |
| `telegram_id` | String | ID пользователя в Telegram |
| `first_name` | String | Имя пользователя |
| `last_name` | String | Фамилия пользователя |
| `created_at` | DateTime | Дата создания записи |
| `updated_at` | DateTime | Дата обновления записи |
| `is_active` | Boolean | Активен ли пользователь |

### Таблица `notifications`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer | Первичный ключ |
| `user_id` | Integer | Внешний ключ к таблице users |
| `type` | Enum | Тип уведомления |
| `title` | String | Заголовок уведомления |
| `content` | Text | Содержание уведомления |
| `is_sent` | Boolean | Отправлено ли уведомление |
| `sent_at` | DateTime | Время отправки уведомления |
| `created_at` | DateTime | Дата создания записи |
| `scheduled_for` | DateTime | Запланированное время отправки |
| `metadata_json` | Text | Дополнительные данные (JSON) |

## API Интеграция

Бот интегрируется с основным веб-приложением через API, реализованное в модуле `api/client.py`. Для этого используются следующие методы:

- `get_user_data(phone_number)`: получение данных пользователя по номеру телефона
- `get_upcoming_matches(days)`: получение предстоящих матчей
- `get_recommended_championships(user_id)`: получение рекомендуемых чемпионатов
- `confirm_notification_delivery(notification_id, delivered)`: подтверждение доставки уведомления
- `get_user_teams(user_id)`: получение команд пользователя
- `get_user_championships(user_id)`: получение чемпионатов пользователя
- `get_user_matches(user_id, status)`: получение матчей пользователя
- `get_team_details(team_id)`: получение детальной информации о команде
- `get_championship_details(tournament_id)`: получение детальной информации о чемпионате
- `accept_team_invitation(invitation_id)`: принятие приглашения в команду
- `decline_team_invitation(invitation_id)`: отклонение приглашения в команду
- `accept_committee_invitation(invitation_id)`: принятие приглашения в оргкомитет
- `decline_committee_invitation(invitation_id)`: отклонение приглашения в оргкомитет
- `get_user_invitations(user_id, type)`: получение приглашений пользователя
- `decline_match(match_id, team_id, reason)`: отклонение участия в матче

## Автоматические задачи

Бот выполняет следующие автоматические задачи:

1. **Проверка новых уведомлений**: каждые 10 секунд бот проверяет наличие новых уведомлений для отправки.

2. **Создание напоминаний о матчах**: ежедневно в 12:00 бот создает напоминания о матчах, которые состоятся через 24 часа.

3. **Удаление старых уведомлений**: ежедневно в 03:00 бот удаляет старые отправленные уведомления (старше 30 дней).

## Разработка и вклад

### Настройка окружения разработки

1. Клонируйте репозиторий и настройте виртуальное окружение:
   ```bash
   git clone https://github.com/yourusername/sports-platform-notifier.git
   cd sports-platform-notifier
   python -m venv venv
   source venv/bin/activate  # для Linux/macOS
   venv\Scripts\activate  # для Windows
   pip install -r requirements.txt
   ```

2. Создайте `.env` файл и настройте его для локальной разработки:
   ```
   TELEGRAM_BOT_TOKEN=your_telegram_bot_token
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=sports_platform_dev
   DB_USER=postgres
   DB_PASSWORD=your_password
   API_BASE_URL=http://localhost:8080/api
   API_TOKEN=your_api_token
   LOG_LEVEL=DEBUG
   ```

3. Выполните инициализацию базы данных:
   ```python
   from database.connection import init_db
   init_db()
   ```

### Структура добавления новых функций

1. Для добавления новой функции:
   - Создайте обработчик в соответствующем файле в директории `bot/handlers/`
   - Добавьте необходимые методы API в `api/client.py`
   - Обновите модели данных в `database/models.py` при необходимости

2. Для добавления нового типа уведомления:
   - Добавьте новый тип в `NotificationType` в `database/models.py`
   - Создайте шаблон сообщения в `bot/messages/templates.py`
   - Обновите логику отправки в `bot/handlers/notification.py`

## Решение проблем

### Частые ошибки и их решения

1. **Ошибка подключения к базе данных**:
   - Проверьте правильность настроек в `.env`
   - Убедитесь, что PostgreSQL запущен и доступен

2. **Ошибка подключения к API**:
   - Проверьте URL и токен API в `.env`
   - Убедитесь, что основное приложение запущено и доступно

3. **Бот не отвечает**:
   - Проверьте токен бота в `.env`
   - Проверьте логи бота (`logs/sports_platform_notifier.log`)

4. **Ошибки при запуске в Docker**:
   - Убедитесь, что Docker и Docker Compose установлены и работают
   - Проверьте логи контейнеров: `docker-compose logs -f`

### Логирование

Логи бота сохраняются в директории `logs/`. Для изменения уровня логирования используйте переменную `LOG_LEVEL` в `.env`:
- `DEBUG`: максимально подробные логи (для разработки)
- `INFO`: стандартный уровень логирования
- `WARNING`: только предупреждения и ошибки
- `ERROR`: только ошибки

## Лицензия

© 2025. Все права защищены.